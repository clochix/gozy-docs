<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="CozyCloud - https://cozy.io">
  <link rel="shortcut icon" href="../../img/favicon.png">
  
  <title>Manual installation - Cozy Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Manual installation";
    var mkdocs_page_input_path = "install/manual.md";
    var mkdocs_page_url = "/install/manual/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Cozy Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      <p><a href="../..../../en">en</a>&nbsp;<a href="../..../../../fr/index_fr">fr</a></p>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Use</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../use/">User guide</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Synchronize</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../sync/">Stay in sync</a>
                </li>
                <li class="">
                    
    <a class="" href="../../sync/phone/">Synchronize your phone</a>
                </li>
                <li class="">
                    
    <a class="" href="../../sync/desktop/">Synchronize your computer</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../download/">Download</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Install</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../">Install Cozy on your own server</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Manual installation</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#how-to-install-cozy-on-debian-stable">How to install Cozy on Debian Stable</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#pre-requisites">Pre-requisites</a></li>
        
            <li><a class="toctree-l4" href="#configuration">Configuration</a></li>
        
            <li><a class="toctree-l4" href="#running">Running</a></li>
        
            <li><a class="toctree-l4" href="#todo">TODO</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Develop</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../dev/">Let's hack some code</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/intro/">Architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/app/">Create your first app</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/konnector/">Develop a connector</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Cozy Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Install &raquo;</li>
        
      
    
    <li>Manual installation</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cozy/cozy-docs-v3/edit/master/src/install/manual.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="how-to-install-cozy-on-debian-stable">How to install Cozy on Debian Stable<a class="headerlink" href="#how-to-install-cozy-on-debian-stable" title="Permanent link">&para;</a></h1><div class="admonition warning">
<p>⚠️ This is a work in progress. For now, there’s no easy and officially supported way to install Cozy. You have to install it and all this dependencies by hand. This tutorial is intended for tech savvy people wanting to give Cozy a first try without waiting for the official documentation and images.</p></div>
<div class="admonition warning">
<p>For now, this documentation don’t explain how to install the technology stack required for connector, as the technology we use may evolve. So you won’t be able to run the connectors.</p></div>
<div class="admonition info">
<p>Most of the following commands require root privileges. You can either open a root shell or use <code>sudo</code> when needed;</p></div>
<h2 id="pre-requisites">Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permanent link">&para;</a></h2><p>Cozy requires a CouchDB 2 database server, a reverse proxy and an SMTP server. We’ll use Nginx in this tutorial but feel free to use your reverse proxy of choice.</p><p>You&rsquo;ll also need a domain name and know how to associate all of its subdomains to the IP address of your server.</p><h3 id="install-couchdb">Install CouchDB<a class="headerlink" href="#install-couchdb" title="Permanent link">&para;</a></h3><h4 id="debian-8">Debian 8<a class="headerlink" href="#debian-8" title="Permanent link">&para;</a></h4><p>CouchDB now has an official package repository, so you just need:</p><pre class="codehilite"><code class="language-shell">curl -L https://couchdb.apache.org/repo/bintray-pubkey.asc | sudo apt-key add -
echo &quot;deb https://apache.bintray.com/couchdb-deb jessie main&quot; | sudo tee -a /etc/apt/sources.list.d/couchdb.list
sudo apt-get update &amp;&amp; sudo apt-get install couchdb</code></pre>


<h4 id="debian-9">Debian 9<a class="headerlink" href="#debian-9" title="Permanent link">&para;</a></h4><p>Waiting for the package repository to support Debian Stretch, you can still build CouchDB 2.1.0 <a href="http://docs.couchdb.org/en/2.1.0/install/unix.html#installation-from-source">by yourself</a>.</p><h3 id="install-the-cozy-stack">Install the Cozy Stack<a class="headerlink" href="#install-the-cozy-stack" title="Permanent link">&para;</a></h3><h4 id="already-compiled">Already compiled<a class="headerlink" href="#already-compiled" title="Permanent link">&para;</a></h4><p>The Cozy server is just a single binary. You can fetch one of its releases from Github:</p><pre class="codehilite"><code class="language-shell">curl -o /usr/local/bin/cozy-stack \
     -L https://github.com/cozy/cozy-stack/releases/download/2017M2-alpha/cozy-stack-linux-amd64-2017M2-alpha
chmod +x /usr/local/bin/cozy-stack
adduser --system \
        --no-create-home \
        --shell /bin/bash \
        --group --gecos \
          &quot;Cozy&quot; cozy
mkdir /var/log/cozy
chown cozy: /var/log/cozy
mkdir /var/lib/cozy
chown -R cozy: /var/lib/cozy</code></pre>


<p>You can configure your server using a JSON or YAML file. Let’s fetch the sample configuration file:</p><pre class="codehilite"><code class="language-shell">mkdir /etc/cozy
curl -o /etc/cozy/cozy.yaml \
     https://raw.githubusercontent.com/cozy/cozy-stack/master/cozy.example.yaml
chown -R cozy: /etc/cozy</code></pre>


<p>Edit this file to adapt it to your configuration. You should setup a directory to store the files. For example:</p><pre class="codehilite"><code class="language-yaml">  fs:
    url: file://localhost/var/lib/cozy</code></pre>


<p>Don’t forget to allow Cozy user to write inside this folder.</p><h4 id="compile-a-recent-stack">Compile a recent stack<a class="headerlink" href="#compile-a-recent-stack" title="Permanent link">&para;</a></h4><p>The released build may not contain the latest fixes. If you want an up to date version of the stack, you can compile it from the sources. This requires to install the Go compiler, fetch the sources and compile them:</p><pre class="codehilite"><code class="language-shell">apt-get --no-install-recommends -y install \
        ca-certificates \
        curl \
        net-tools \
        nginx \
        sudo \
        vim-tiny \
        build-essential \
        pkg-config \
        erlang \
        libicu-dev \
        libmozjs185-dev \
        libcurl4-openssl-dev \
        git
cd /tmp
curl -LO https://storage.googleapis.com/golang/go1.8.3.linux-amd64.tar.gz
tar -C /usr/local -xzf go1.8.3.linux-amd64.tar.gz
PATH=$PATH:/usr/local/go/bin go get -u github.com/cozy/cozy-stack
cp /root/go/bin/cozy-stack /usr/local/bin/cozy-stack
chmod +x /usr/local/bin/cozy-stack</code></pre>


<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2><h3 id="cozy">Cozy<a class="headerlink" href="#cozy" title="Permanent link">&para;</a></h3><p>The Cozy server requires a main password:</p><pre class="codehilite"><code class="language-shell">sudo /usr/local/bin/cozy-stack config passwd /etc/cozy/</code></pre>


<p>This password will be asked every time you use the <code>cozy-stack</code> command line. To prevent this, you can set the 
<code>COZY_ADMIN_PASSWORD</code> environment variable.</p><h3 id="nginx-and-self-signed-certificates">NGinx and self-signed certificates<a class="headerlink" href="#nginx-and-self-signed-certificates" title="Permanent link">&para;</a></h3><p>Let’s assume you want to host a server on <code>mycozy.tld</code> with a self-signed certificate.</p><p>Generate the certificate. We need a wild-card certificate, as every application inside Cozy will have it’s own sub-domain:</p><pre class="codehilite"><code class="language-shell">sudo openssl req -x509 -nodes -newkey rsa:4096 \
    -keyout /etc/cozy/mycozy.tld.key \
    -out /etc/cozy/mycozy.tld.crt \
    -days 365 -subj &quot;/CN={*.mycozy.tld}&quot;</code></pre>


<p>Then create a virtual host for your server by creating a file at <code>/etc/cozy/sites-available/mycozy.tld.conf</code> with the following configuration template.</p><p>=====
Then create a virtual host for your server by creating <code>/etc/nginx/sites-available/mycozy.tld</code> and enable it by creating a symbolic link:</p><pre class="codehilite"><code class="language-shell">sudo ln -s &quot;/etc/nginx/sites-available/mycozy.tld.conf&quot; \
       /etc/nginx/sites-enabled/</code></pre>


<p>You can check that your configuration is valid by running</p><pre class="codehilite"><code class="language-shell">sudo nginx -t -c /etc/nginx/nginx.conf</code></pre>


<p>And start NGinx:</p><pre class="codehilite"><code class="language-shell">sudo service nginx start</code></pre>


<p>Or, if you use systemd:</p><pre class="codehilite"><code class="language-shell">sudo systemctl start nginx
sudo systemctl enable nginx # enable the nginx service at startup, if need to</code></pre>


<h4 id="sample-configuration-files">Sample configuration files<a class="headerlink" href="#sample-configuration-files" title="Permanent link">&para;</a></h4><p>Put this file into <code>/etc/nginx/sites-available</code> and enable it by creating a symlink in 
<code>/etc/nginx/sites-enabled</code>.</p><p>In this template, you need to replace the following placeholders:
  - %PORT% with the public port nginx will listen to (default should be 443);
  - %SERVER_PORT% with the private port cozy will listen to (default should be 8080);
  - %DOMAIN% with your domain of choice: <code>mycozy.tld</code> in this example</p><pre class="codehilite"><code class="language-nginx">server {
    listen %PORT%;

    server_name *.%DOMAIN%;

    ssl_certificate /etc/cozy/%DOMAIN%.crt;
    ssl_certificate_key /etc/cozy/%DOMAIN%.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers EECDH+AES;
    ssl_prefer_server_ciphers on;
    ssl on;

    gzip_vary on;
    client_max_body_size 1024M;

    add_header Strict-Transport-Security max-age=31536000;

    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect http:// https://;
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &quot;upgrade&quot;;
    }

    access_log /var/log/nginx/cozy.log;
}</code></pre>


<h3 id="apache-and-lets-encrypt-certificates">Apache and Let&rsquo;s Encrypt certificates<a class="headerlink" href="#apache-and-lets-encrypt-certificates" title="Permanent link">&para;</a></h3><p>Cozy is leveraging subdomains, one way (<code>app.user.domain.tld</code>) or the other (
<code>app-user.domain.tld</code>). While your DNS and your Apache Virtual Hosts can easily be wildcarded, Let&rsquo;s Encrypt certificates don&rsquo;t (at least until January 2018). But they can contain multiple domains, and that&rsquo;s what you can leverage:</p><ul>
<li>First you need to define a virtual host for you Cozy instance:</li></ul>
<p><code>/etc/apache2/sites-available/mycozy.tld.conf</code>:</p><pre class="codehilite"><code class="language-apacheconf">&lt;VirtualHost *:443&gt;
    ServerName mycozy.tld
    ServerAlias *.mycozy.tld

    ProxyPass / http://127.0.0.1:8080/
    ProxyPassReverse / mycozy.tld
    ProxyPreserveHost on

    ErrorLog ${APACHE_LOG_DIR}/error_cozy.log
    CustomLog ${APACHE_LOG_DIR}/access_cozy.log combined
&lt;/VirtualHost&gt;</code></pre>


<pre class="codehilite"><code class="language-shell">sudo a2ensite mycozy.tld.conf
sudo service apache2 reload</code></pre>


<p>Note that this virtual host is listening on port 443, yet it doesn&rsquo;t enable <code>SSLEngine</code>. It&rsquo;s because Certbot needs this virtual host to perform TLS-DNI domain validation challenge to be able to generate your TLS certificate (more details 
<a href="https://certbot.eff.org/docs/using.html#getting-certificates-and-choosing-plugins">here</a> ).</p><ul>
<li>Now you can generate Let&rsquo;s Encrypt certificates, using <a href="https://certbot.eff.org/#debianjessie-apache">Certbot</a>:</li></ul>
<pre class="codehilite"><code class="language-shell">sudo certbot certonly --apache --domains mycozy.tld,drive.mycozy.tld,photos.mycozy.tld,settings.mycozy.tld</code></pre>


<p>This will generate 1 certificate containing multiple sub-domains. It is installed in <code>/etc/letsencrypt/live/mycozy.tld</code>.</p><ul>
<li>So the final step is to enable SSL/TLS in your virtual host:</li></ul>
<p><code>/etc/apache2/sites-available/mycozy.tld</code>:</p><pre class="codehilite"><code class="language-apacheconf">    ...
    SSLEngine on
    Header always set Strict-Transport-Security &quot;max-age=31536000; includeSubDomains&quot;
    SSLCertificateFile &quot;/etc/letsencrypt/live/mycozy.tld/fullchain.pem&quot;
    SSLCertificateKeyFile &quot;/etc/letsencrypt/live/mycozy.tld/privkey.pem&quot;
    ...</code></pre>


<pre class="codehilite"><code class="language-shell">sudo service apache2 reload</code></pre>


<h4 id="automation-for-multiple-instances">Automation for multiple instances<a class="headerlink" href="#automation-for-multiple-instances" title="Permanent link">&para;</a></h4><p>You can make all this automated in 2 simple steps:</p><ul>
<li>Define a virtual host template:</li></ul>
<pre class="codehilite"><code class="language-apacheconf">#&lt;VirtualHost *:80&gt;
#    ServerName __DOMAIN__
#    ServerAlias *.__DOMAIN__
#
#    # Force SSL
#    Redirect permanent / &quot;https://%{HTTP_HOST}&quot;
#&lt;/VirtualHost&gt;

&lt;VirtualHost *:443&gt;
    ServerName __DOMAIN__
    ServerAlias *.__DOMAIN__

#    SSLEngine on
#    Header always set Strict-Transport-Security &quot;max-age=31536000; includeSubDomains&quot;
#    SSLCertificateFile &quot;/etc/letsencrypt/live/__DOMAIN__/fullchain.pem&quot;
#    SSLCertificateKeyFile &quot;/etc/letsencrypt/live/__DOMAIN__/privkey.pem&quot;

    ProxyPass / http://127.0.0.1:8080/
    ProxyPassReverse / __DOMAIN__
    ProxyPreserveHost on

    ErrorLog ${APACHE_LOG_DIR}/error___DOMAIN__.log
    CustomLog ${APACHE_LOG_DIR}/access___DOMAIN__.log combined
&lt;/VirtualHost&gt;</code></pre>


<ul>
<li>Then define this script, that will take care of creating Cozy instance as well as Apache/Let&rsquo;s Encrypt stuff:</li></ul>
<pre class="codehilite"><code class="language-shell">#!/bin/bash

domain=$1
apps=$2
vhost=&quot;$domain.conf&quot;
vhost_file=&quot;/etc/apache2/sites-available/$vhost&quot;

passphrase=`openssl rand -base64 12 | head -c -3`
echo &quot;Adding Cozy instance with passphase $passphrase&quot;
sudo -u cozy cozy-stack instances add --host 0.0.0.0 --apps $apps --passphrase $passphrase $domain


domains=&quot;$domain&quot;

IFS=',' read -ra apps_array &lt;&lt;&lt; &quot;$apps&quot;
for app in &quot;${apps_array[@]}&quot;; do
    domains=&quot;$domains,$app.$domain&quot;
done

echo &quot;Creating Apache virtual host for Certbot to be able to use TLS-SNI challenge&quot;
sed &quot;s/__DOMAIN__/$domain/g&quot; cozy_vhost.conf | sudo tee $vhost_file &gt; /dev/null

sudo a2ensite $vhost
sudo service apache2 reload

echo &quot;Getting Let's Encrypt certificate for $domains&quot;
sudo certbot certonly --apache --non-interactive --force-renewal --quiet --domains $domains

echo &quot;Enabling Let's Encrypt certificate, reloading Apache&quot;
sudo sed -i 's/^#//g' $vhost_file
sudo service apache2 reload</code></pre>


<ul>
<li>You can use this script this way:</li></ul>
<pre class="codehilite"><code class="language-shell">./cozy_add_instance.sh alice.mycozy.tld drive,photos,collect,settings
./cozy_add_instance.sh bob.mycozy.tld drive,photos,collect,settings</code></pre>


<h3 id="dns">DNS<a class="headerlink" href="#dns" title="Permanent link">&para;</a></h3><p>Make sure to associate <code>*.mycozy.tld</code> with the IP address of your server.</p><p>For example, add the following records to your DNS (replacing <code>mycozy.tld</code> with your domain of choice):</p><pre class="codehilite"><code>mycozy.tld   A     your IP
*.mycozy.tld CNAME mycozy.tld</code></pre>


<h2 id="running">Running<a class="headerlink" href="#running" title="Permanent link">&para;</a></h2><p>For now, we’ll just run the server as a background job, but it is highly recommended to use some supervisor software.</p><p>First, start the server:</p><pre class="codehilite"><code class="language-shell">sudo -b -u cozy sh -c '/usr/local/bin/cozy-stack serve \
     --log-level info \
     --host 0.0.0.0 &gt;&gt; /var/log/cozy/cozy.log 2&gt;&gt; /var/log/cozy/cozy-err.log'</code></pre>


<p>Then, create your instance and install the applications:</p><pre class="codehilite"><code class="language-shell">cozy-stack instances add \
           --host 0.0.0.0 \
           --apps drive,photos,collect,settings \
           --passphrase &quot;XXX&quot; \
           mycozy.tld</code></pre>


<p><code>&ndash;passphrase &ldquo;XXX&rdquo;</code> allows to set the initial password of the instance.</p><p>You can add other instances by just running this commands again.</p><div class="admonition info">
<p>The url of your cozy determines the name of your instance.
If you choose another public port than the default public port for SSL (443), say <code>1443</code>, then you should reflect this when creating your cozy instance with the ${instance_domain} as 
<code>mycozy.tld:1443</code>.</p></div>
<h2 id="todo">TODO<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h2><p>Cozy also requires a SMTP server (or relay).</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../dev/" class="btn btn-neutral float-right" title="Let's hack some code">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../" class="btn btn-neutral" title="Install Cozy on your own server"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <!-- Piwik -->
  <script type="text/javascript">
    var _paq = _paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//piwik.cozycloud.cc/";
      _paq.push(['setTrackerUrl', u+'piwik.php']);
      _paq.push(['setSiteId', '7']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <noscript><p><img src="//piwik.cozycloud.cc/piwik.php?idsite=7&rec=1" style="border:0;" alt="" /></p></noscript>
  <!-- End Piwik Code -->

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/cozy/cozy-docs-v3" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../dev/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
